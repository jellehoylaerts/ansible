---
- name: Create all necessary directories
  file:
    path: "/srv/lancache/{{ item }}"
    state: directory
    mode: 0777
    owner: lancache
    group: lancache
  with_items:
    - logs/Errors
    - logs/Keys
    - logs/Access
    - data/apple
    - data/microsoft
    - data/installs
    - data/other
    - data/tmp
    - data/hirez
    - data/origin
    - data/riot
    - data/gog
    - data/sony
    - data/steam
    - data/wargaming
    - data/arenanetworks
    - data/uplay
    - data/glyph
    - data/zenimax
    - data/digitalextremes
    - data/pearlabyss
    - data/blizzard
    - data/enmasse

- name: Create symlink for LANcache logs
  file:
    src: /srv/lancache/logs
    dest: /var/log/lancache
    state: link

- name: Clone git LANcache project
  git:
    repo: http://github.com/bntjah/lancache
    dest: "{{ lc.base_folder }}"
    force: true

- name: Replace aliases by ip  
  replace:
    path: "{{ lc.base_folder }}/hosts"
    regexp: "{{ item.search }}"
    replace: "{{ item.replace }}"
  loop:
    - { search: 'lc-hostname', replace: '{{ inventory_hostname }}' }
    - { search: 'lc-host-proxybind', replace: '{{ lc.ip }}' }
    - { search: 'lc-host-arena', replace: '{{ lc.ip_arena }}' }
    - { search: 'lc-host-apple', replace: '{{ lc.ip_apple }}' }
    - { search: 'lc-host-blizzard', replace: '{{ lc.ip_blizzard }}' }
    - { search: 'lc-host-hirez', replace: '{{ lc.ip_hirez }}' }
    - { search: 'lc-host-glyph', replace: '{{ lc.ip_glyph }}' }
    - { search: 'lc-host-gog', replace: '{{ lc.ip_gog }}' }
    - { search: 'lc-host-microsoft', replace: '{{ lc.ip_microsoft }}' }
    - { search: 'lc-host-origin', replace: '{{ lc.ip_origin }}' }
    - { search: 'lc-host-riot', replace: '{{ lc.ip_riot }}' }
    - { search: 'lc-host-steam', replace: '{{ lc.ip_steam }}' }
    - { search: 'lc-host-sony', replace: '{{ lc.ip_sony }}' }
    - { search: 'lc-host-enmasse', replace: '{{ lc.ip_enmasse }}' }
    - { search: 'lc-host-uplay', replace: '{{ lc.ip_uplay }}' }
    - { search: 'lc-host-wargaming', replace: '{{ lc.ip_wargaming }}' }
    - { search: 'lc-host-zenimax', replace: '{{ lc.ip_zenimax }}' }
    - { search: 'lc-host-digitalextremes', replace: '{{ lc.ip_digitalextremes }}' }
    - { search: 'lc-host-pearlabyss', replace: '{{ lc.ip_pearlabyss }}' }

- name: Copy hosts file to /etc/hosts
  copy:
    src: "{{ lc.base_folder }}/hosts"
    dest: /etc/hosts
    remote_src: true
    owner: root
    group: root
    mode: 0644

- name: Copy LANcache configuration
  command: "cp -rf {{ lc.base_folder }}/conf/lancache /etc/nginx/"

- name: Copy LANcache vhosts
  command: "cp -rf {{ lc.base_folder }}/conf/vhosts-enabled /etc/nginx/"

- name: Copy Nginx config file
  template:
    src: nginx.conf
    dest: /etc/nginx/nginx.conf

- name: Replace variables in vhost files
  replace:
    path: "/etc/nginx/vhosts-enabled/lancache-{{ item }}.conf"
    regexp: lc-host-proxybind
    replace: "{{ lc.ip }}"
  loop:
    - apple
    - arenanetworks
    - blizzard
    - digitalextremes
    - enmasse
    - glyph
    - gog
    - hirez
    - microsoft
    - origin
    - pearlabyss
    - riot
    - sony
    - steam
    - uplay
    - wargaming
    - zenimax

- name: Change ownership of directorties
  file:
    path: "{{ item }}"
    owner: lancache
    group: lancache
    recurse: true
  with_items:
    - /srv/
    - /etc/nginx/
  notify:
    - Restart nginx
